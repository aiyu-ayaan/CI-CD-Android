name : Build Debug üèóÔ∏è

on :
  push :
    tags:
      - v*


jobs :
  build :
    runs-on : ubuntu-latest
    steps:
      - uses : actions/checkout@v2
      - name : set up JDK 11
        uses : actions/setup-java@v1
        with :
            java-version : 11
            distribution : 'temurin'
            cache : gradle

      - name : Make gradlew executable
        run : chmod +x ./gradlew
      - name : Build Release APK
        run : ./gradlew :app:assembleRelease --stacktrace :app:bundleRelease --stacktrace
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}

      - name : Upload
        uses : actions/upload-artifact@v2
        with :
            name : apk
            path : app/build/outputs/apk/release/app-release-unsigned.apk

      - name : Upload
        uses : actions/upload-artifact@v2
        with :
            name : abb
            path : app/build/outputs/bundle/release/app-release.aab
  release:
    name : Release APK
    needs : build
    runs-on : ubuntu-latest
    steps :
      - name: Download APK from build
        uses: actions/download-artifact@v3
        with:
          name: apk
      - name: Download ABB from build
        uses: actions/download-artifact@v3
        with:
          name: abb
      # - name: Create Release
      #   id: create_release
      #   uses: actions/create-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.ACCOUNT_TOKEN }}
      #   with:
      #     tag_name: ${{ github.ref  }}
      #     release_name: ${{ github.event.repository.name }} ${{ github.ref }}

      # Rename the apk file to the tag name
      - name: Rename APK
        run: |
          echo ${{ github.ref }}
          v=$(echo ${{ github.ref }} | cut -c 11-)
          mv ./app-release-unsigned.apk CI_CD_$v.apk

          


      #  Rename the abb file to the tag name
      - name: Rename ABB
        run: |
          echo ${{ github.ref }}
          v=$(echo ${{ github.ref }} | cut -c 11-)
          mv ./app-release-unsigned.apk CI_CD_$v.abb
      # use this to softprops/action-gh-release@v1 upload the apk file to the release
      - name: Upload APK to Release
        env:
          GITHUB_TOKEN: ${{ secrets.ACCOUNT_TOKEN }}
        uses: softprops/action-gh-release@v1
        with:
          files: |
            CI_CD $v.apk
            CI_CD $v.abb
          prerelease: true
          # get that tag name only
          tag_name: ${{ steps.create_release.outputs.tag_name }}
          token: ${{ secrets.ACCOUNT_TOKEN }}
